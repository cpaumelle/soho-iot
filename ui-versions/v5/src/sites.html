<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sites Manager V5 - Verdegris IoT Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
    <style>
        .archived-site {
            opacity: 0.6;
            background-color: #f8f9fa;
        }
        .archived-site td {
            color: #6c757d;
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background-color: #f8f9fa;
        }
        .sort-arrow {
            float: right;
            margin-left: 5px;
            opacity: 0.5;
        }
        .sort-asc .sort-arrow::after {
            content: "‚Üë";
            opacity: 1;
        }
        .sort-desc .sort-arrow::after {
            content: "‚Üì";
            opacity: 1;
        }
        
        /* Map styles */
        #sitesOverviewMap {
            height: 300px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        #siteFormMap {
            height: 350px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        /* Address search styles */
        .address-search-container {
            position: relative;
        }
        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .address-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .address-suggestion:hover {
            background-color: #f8f9fa;
        }
        .address-suggestion:last-child {
            border-bottom: none;
        }
        
        /* Site overview card styles */
        .sites-overview-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .sites-overview-card .card-title {
            color: white;
        }
        .sites-overview-card .text-muted {
            color: rgba(255,255,255,0.8) !important;
        }
        
        /* Icon picker styles */
        .icon-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        .icon-picker span {
            display: inline-block;
            padding: 8px;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }
        .icon-picker span:hover {
            border-color: #ccc;
            background-color: #f8f9fa;
        }
        .icon-picker span.selected {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        
        /* Loading states */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        .btn-loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">Verdegris IoT Platform V5</a>
            <div class="navbar-nav">
                <a class="nav-link" href="dashboard.html">Dashboard</a>
                <a class="nav-link" href="device-types.html">Device Types</a>
                <a class="nav-link active" href="sites.html">Sites</a>
                <a class="nav-link" href="locations.html">Locations</a>
                <a class="nav-link" href="devices.html">Device Locations</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1>Sites Manager <span class="badge bg-success">V5 Enhanced</span></h1>
                        <p class="text-muted">Create, read, update, and archive facility sites with map integration</p>
                    </div>
                    <button class="btn btn-primary" onclick="showAddSiteForm()">
                        üìç Create New Site
                    </button>
                </div>
            </div>
        </div>

        <!-- Sites Overview Map -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card sites-overview-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="card-title mb-1">Sites Overview</h5>
                                <p class="text-muted mb-0">Geographic distribution of your facilities</p>
                            </div>
                            <div class="text-end">
                                <h3 class="mb-0" id="mapSitesCount">0</h3>
                                <small class="text-muted">Active Sites</small>
                            </div>
                        </div>
                        <div id="sitesOverviewMap"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Controls -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="input-group">
                    <span class="input-group-text">üîç</span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search sites by name or address..." onkeyup="filterSites()">
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-3 justify-content-end">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showArchived" checked onchange="filterSites()">
                        <label class="form-check-label" for="showArchived">Show archived</label>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearSearch()">Clear</button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading sites...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="alert alert-danger d-none" role="alert">
            <h4 class="alert-heading">Error Loading Sites</h4>
            <p id="error-message"></p>
            <button class="btn btn-outline-danger" onclick="loadSites()">Retry</button>
        </div>

        <!-- Add/Edit Site Form -->
        <div id="site-form-container" class="card mb-4 d-none">
            <div class="card-header">
                <h5 class="card-title mb-0" id="form-title">Create New Site</h5>
            </div>
            <div class="card-body">
                <form id="site-form">
                    <input type="hidden" id="site-id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="site-name" class="form-label">Site Name *</label>
                                <input type="text" class="form-control" id="site-name" required>
                                <div class="form-text">Enter a descriptive name for the site</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="site-address" class="form-label">Address</label>
                                <div class="address-search-container">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="site-address" placeholder="Search for address or enter manually">
                                        <button class="btn btn-outline-secondary" type="button" onclick="searchAddressManual()" id="searchAddressBtn">
                                            üîç Search
                                        </button>
                                    </div>
                                    <div id="addressSuggestions" class="address-suggestions d-none"></div>
                                </div>
                                <div class="form-text">Start typing to search for addresses, or click on the map</div>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="site-latitude" class="form-label">Latitude</label>
                                        <input type="number" step="any" class="form-control" id="site-latitude" readonly>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="site-longitude" class="form-label">Longitude</label>
                                        <input type="number" step="any" class="form-control" id="site-longitude" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Site Icon</label>
                                <div class="icon-picker" id="siteIconPicker">
                                    <span data-icon="">üè¢</span>
                                    <span data-icon="building">üè¢</span>
                                    <span data-icon="factory">üè≠</span>
                                    <span data-icon="warehouse">üè™</span>
                                    <span data-icon="office">üè£</span>
                                    <span data-icon="retail">üõí</span>
                                    <span data-icon="hospital">üè•</span>
                                    <span data-icon="school">üè´</span>
                                    <span data-icon="hotel">üè®</span>
                                    <span data-icon="home">üè°</span>
                                </div>
                                <input type="hidden" id="site-icon">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Location on Map</label>
                                <div id="siteFormMap"></div>
                                <div class="form-text mt-2">Click on the map to set the exact location, or search by address</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="form-submit-btn">
                            <span class="btn-text">Create Site</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="cancelForm()">Cancel</button>
                        <button type="button" class="btn btn-outline-info" onclick="getCurrentLocation()" id="locationBtn">
                            üìç Use My Location
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sites Table -->
        <div id="sites-content" class="d-none">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Sites</h5>
                    <small class="text-muted" id="sites-count">0 sites</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th class="sortable" onclick="sortTable('name')">
                                        Name <span class="sort-arrow"></span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('address')">
                                        Address <span class="sort-arrow"></span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('status')">
                                        Status <span class="sort-arrow"></span>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sites-table-body">
                                <!-- Sites will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-sites" class="text-center py-4 d-none">
                        <p class="text-muted">No sites found matching your criteria.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="api.js"></script>
    <script>
        let allSites = [];
        let filteredSites = [];
        let editingSiteId = null;
        let currentSort = { field: 'name', direction: 'asc' };
        
        // Map instances
        let overviewMap = null;
        let formMap = null;
        let formMarker = null;
        let overviewMarkers = [];
        
        // Address search
        let addressSearchTimeout = null;

        // Load sites on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSites();
            setupAddressSearch();
            setupIconPicker();
        });

        function initializeOverviewMap() {
            if (overviewMap) return;
            
            overviewMap = L.map('sitesOverviewMap').setView([48.8566, 2.3522], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(overviewMap);
        }

        function initializeFormMap() {
            if (formMap) return;
            
            formMap = L.map('siteFormMap').setView([48.8566, 2.3522], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(formMap);

            // Add click handler to form map
            formMap.on('click', function(e) {
                const { lat, lng } = e.latlng;
                updateFormMapMarker(lat, lng);
                reverseGeocode(lat, lng);
            });
        }

        function updateFormMapMarker(lat, lng) {
            if (formMarker) {
                formMarker.setLatLng([lat, lng]);
            } else {
                formMarker = L.marker([lat, lng], { draggable: true }).addTo(formMap);
                formMarker.on('dragend', function(e) {
                    const { lat, lng } = e.target.getLatLng();
                    updateCoordinateInputs(lat, lng);
                    reverseGeocode(lat, lng);
                });
            }
            
            updateCoordinateInputs(lat, lng);
        }

        function updateCoordinateInputs(lat, lng) {
            document.getElementById('site-latitude').value = lat.toFixed(6);
            document.getElementById('site-longitude').value = lng.toFixed(6);
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                
                if (data && data.display_name) {
                    document.getElementById('site-address').value = data.display_name;
                }
            } catch (error) {
                console.error('Reverse geocoding failed:', error);
            }
        }

        function setupAddressSearch() {
            const addressInput = document.getElementById('site-address');
            const suggestionsDiv = document.getElementById('addressSuggestions');

            addressInput.addEventListener('input', function() {
                clearTimeout(addressSearchTimeout);
                const query = this.value.trim();
                
                if (query.length < 3) {
                    suggestionsDiv.classList.add('d-none');
                    return;
                }
                
                addressSearchTimeout = setTimeout(() => {
                    searchAddress(query, true);
                }, 300);
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.address-search-container')) {
                    suggestionsDiv.classList.add('d-none');
                }
            });
        }

        function setupIconPicker() {
            const iconPicker = document.getElementById('siteIconPicker');
            iconPicker.addEventListener('click', function(e) {
                if (e.target.tagName === 'SPAN') {
                    // Remove selection from all icons
                    this.querySelectorAll('span').forEach(s => s.classList.remove('selected'));
                    // Add selection to clicked icon
                    e.target.classList.add('selected');
                    // Update hidden input
                    document.getElementById('site-icon').value = e.target.dataset.icon || '';
                }
            });

            // Select first icon by default
            iconPicker.querySelector('span').classList.add('selected');
        }

        async function searchAddress(query = null, showSuggestions = false) {
            const searchQuery = query || document.getElementById('site-address').value.trim();
            const suggestionsDiv = document.getElementById('addressSuggestions');
            const searchBtn = document.getElementById('searchAddressBtn');
            
            if (!searchQuery) {
                if (!showSuggestions) {
                    showAlert('warning', 'Please enter an address to search');
                }
                return;
            }
            
            if (!showSuggestions) {
                searchBtn.classList.add('btn-loading');
                searchBtn.disabled = true;
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5&countrycodes=fr,gb&addressdetails=1`);
                const data = await response.json();
                
                if (showSuggestions) {
                    // Show suggestions dropdown
                    suggestionsDiv.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(result => {
                            const suggestion = document.createElement('div');
                            suggestion.className = 'address-suggestion';
                            suggestion.textContent = result.display_name;
                            suggestion.onclick = () => selectAddress(result);
                            suggestionsDiv.appendChild(suggestion);
                        });
                        suggestionsDiv.classList.remove('d-none');
                    } else {
                        suggestionsDiv.classList.add('d-none');
                    }
                } else if (data.length > 0) {
                    // Use first result for direct search
                    selectAddress(data[0]);
                } else {
                    showAlert('warning', 'No results found for this address');
                }
            } catch (error) {
                console.error('Error searching address:', error);
                if (!showSuggestions) {
                    showAlert('danger', 'Error searching address. Please try again.');
                }
            } finally {
                if (!showSuggestions) {
                    searchBtn.classList.remove('btn-loading');
                    searchBtn.disabled = false;
                }
            }
        }

        function selectAddress(result) {
            // Update address input
            document.getElementById('site-address').value = result.display_name;
            
            // Hide suggestions
            document.getElementById('addressSuggestions').classList.add('d-none');
            
            // Initialize form map if needed
            if (!formMap) {
                initializeFormMap();
                // Give map time to initialize
                setTimeout(() => {
                    updateMapFromAddress(result);
                }, 300);
            } else {
                updateMapFromAddress(result);
            }
        }

        function updateMapFromAddress(result) {
            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);
            
            formMap.setView([lat, lng], 16);
            updateFormMapMarker(lat, lng);
        }

        function searchAddressManual() {
            searchAddress();
        }

        async function getCurrentLocation() {
            const locationBtn = document.getElementById('locationBtn');
            
            if (!navigator.geolocation) {
                showAlert('warning', 'Geolocation is not supported by this browser');
                return;
            }

            locationBtn.classList.add('btn-loading');
            locationBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    if (!formMap) {
                        initializeFormMap();
                        setTimeout(() => {
                            formMap.setView([lat, lng], 16);
                            updateFormMapMarker(lat, lng);
                            reverseGeocode(lat, lng);
                        }, 300);
                    } else {
                        formMap.setView([lat, lng], 16);
                        updateFormMapMarker(lat, lng);
                        reverseGeocode(lat, lng);
                    }
                    
                    locationBtn.classList.remove('btn-loading');
                    locationBtn.disabled = false;
                    showAlert('success', 'Location detected successfully!');
                },
                function(error) {
                    locationBtn.classList.remove('btn-loading');
                    locationBtn.disabled = false;
                    
                    let message = 'Unable to get your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Location access denied by user';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            message = 'Location request timed out';
                            break;
                    }
                    showAlert('warning', message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        async function loadSites() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('sites-content');

            // Show loading state
            loading.classList.remove('d-none');
            error.classList.add('d-none');
            content.classList.add('d-none');

            try {
                const api = new APIClient('https://api.sensemy.cloud');
                const sites = await api.get('/v1/sites');

                allSites = sites;
                filterSites(); // Apply current filter
                updateOverviewMap();

                // Show content, hide loading
                loading.classList.add('d-none');
                content.classList.remove('d-none');

            } catch (err) {
                console.error('Error loading sites:', err);

                // Show error state
                loading.classList.add('d-none');
                error.classList.remove('d-none');
                document.getElementById('error-message').textContent =
                    'Failed to load sites: ' + err.message;
            }
        }

        function updateOverviewMap() {
            // Initialize map if needed
            if (!overviewMap) {
                initializeOverviewMap();
            }

            // Clear existing markers
            overviewMarkers.forEach(marker => overviewMap.removeLayer(marker));
            overviewMarkers = [];

            // Add markers for sites with coordinates (non-zero coordinates only)
            const sitesWithCoords = allSites.filter(site => 
                site.latitude && site.longitude && 
                parseFloat(site.latitude) !== 0 && parseFloat(site.longitude) !== 0
            );
            
            const activeSitesWithCoords = sitesWithCoords.filter(site => {
                if (!site.archived_at) return true;
                const archivedValue = site.archived_at.toString().trim();
                return archivedValue === '' || archivedValue === 'null' || archivedValue === 'NULL';
            });
            
            // Show all sites or just active based on filter
            const showArchived = document.getElementById('showArchived').checked;
            const sitesToShow = showArchived ? sitesWithCoords : activeSitesWithCoords;
            
            sitesToShow.forEach(site => {
                let isArchived = false;
                if (site.archived_at) {
                    const archivedValue = site.archived_at.toString().trim();
                    isArchived = archivedValue !== '' && archivedValue !== 'null' && archivedValue !== 'NULL';
                }
                
                // Create custom icon for archived sites
                const markerIcon = isArchived ? 
                    L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background-color: #6c757d; width: 25px; height: 25px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">üì¶</div>',
                        iconSize: [25, 25],
                        iconAnchor: [12, 12]
                    }) : 
                    new L.Icon.Default();

                const marker = L.marker([parseFloat(site.latitude), parseFloat(site.longitude)], { icon: markerIcon })
                    .bindPopup(`
                        <div class="text-center">
                            <strong>${escapeHtml(site.name)}</strong>
                            ${isArchived ? '<span class="badge bg-secondary ms-2">Archived</span>' : ''}
                            <br>
                            <small class="text-muted">${escapeHtml(site.address || 'No address')}</small><br>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-primary" onclick="editSite(${site.id})">Edit</button>
                                <a href="locations.html?site_id=${site.id}" class="btn btn-sm btn-info">Locations</a>
                                ${isArchived ? 
                                    `<button class="btn btn-sm btn-success" onclick="restoreSite(${site.id})">Restore</button>` :
                                    `<button class="btn btn-sm btn-warning" onclick="archiveSite(${site.id})">Archive</button>`
                                }
                            </div>
                        </div>
                    `)
                    .addTo(overviewMap);
                
                overviewMarkers.push(marker);
            });

            // Update counter - show active sites count
            document.getElementById('mapSitesCount').textContent = activeSitesWithCoords.length;

            // Fit map to markers if any exist
            if (overviewMarkers.length > 0) {
                const group = new L.featureGroup(overviewMarkers);
                overviewMap.fitBounds(group.getBounds().pad(0.1));
            } else if (sitesWithCoords.length > 0) {
                // If no markers shown but sites exist, center on first site
                const firstSite = sitesWithCoords[0];
                overviewMap.setView([parseFloat(firstSite.latitude), parseFloat(firstSite.longitude)], 6);
            }
        }

        function filterSites() {
            const showArchived = document.getElementById('showArchived').checked;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            let sitesToShow = allSites;

            // Filter by archived status - handle various timestamp formats
            if (!showArchived) {
                sitesToShow = sitesToShow.filter(site => {
                    if (!site.archived_at) return true;
                    const archivedValue = site.archived_at.toString().trim();
                    return archivedValue === '' || archivedValue === 'null' || archivedValue === 'NULL';
                });
            }

            // Filter by search term
            if (searchTerm) {
                sitesToShow = sitesToShow.filter(site =>
                    (site.name && site.name.toLowerCase().includes(searchTerm)) ||
                    (site.address && site.address.toLowerCase().includes(searchTerm))
                );
            }

            filteredSites = sitesToShow;
            applySorting();
            displaySites(filteredSites);
            updateSitesCount();
            updateOverviewMap(); // Update map when filter changes
        }

        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }

            updateSortIcons();
            applySorting();
            displaySites(filteredSites);
        }

        function applySorting() {
            filteredSites.sort((a, b) => {
                let aVal, bVal;

                if (currentSort.field === 'status') {
                    // More robust check for archived status
                    const aArchived = a.archived_at ? a.archived_at.toString().trim() : '';
                    const bArchived = b.archived_at ? b.archived_at.toString().trim() : '';
                    
                    aVal = (aArchived !== '' && aArchived !== 'null' && aArchived !== 'NULL') ? 'archived' : 'active';
                    bVal = (bArchived !== '' && bArchived !== 'null' && bArchived !== 'NULL') ? 'archived' : 'active';
                } else {
                    aVal = (a[currentSort.field] || '').toString().toLowerCase();
                    bVal = (b[currentSort.field] || '').toString().toLowerCase();
                }

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function updateSortIcons() {
            // Remove all sort classes
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // Add sort class to current column
            const currentHeader = document.querySelector(`[onclick="sortTable('${currentSort.field}')"]`);
            if (currentHeader) {
                currentHeader.classList.add(`sort-${currentSort.direction}`);
            }
        }

        function updateSitesCount() {
            const count = filteredSites.length;
            const total = allSites.length;
            document.getElementById('sites-count').textContent =
                count === total ? `${count} sites` : `${count} of ${total} sites`;
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterSites();
        }

        function displaySites(sites) {
            const tbody = document.getElementById('sites-table-body');
            const noSites = document.getElementById('no-sites');

            if (!sites || sites.length === 0) {
                tbody.innerHTML = '';
                noSites.classList.remove('d-none');
                return;
            }

            noSites.classList.add('d-none');

            tbody.innerHTML = sites.map(site => {
                // Check if archived_at exists and is not null/empty
                const isArchived = site.archived_at && site.archived_at !== null && site.archived_at.trim() !== '';
                const rowClass = isArchived ? 'archived-site' : '';
                const status = isArchived ?
                    `<span class="badge bg-secondary">Archived</span>` :
                    `<span class="badge bg-success">Active</span>`;

                const hasCoordinates = site.latitude && site.longitude;
                const locationInfo = hasCoordinates ? 
                    `<small class="text-muted d-block">üìç ${parseFloat(site.latitude).toFixed(4)}, ${parseFloat(site.longitude).toFixed(4)}</small>` : 
                    `<small class="text-warning d-block">üìç No coordinates</small>`;

                return `
                    <tr class="${rowClass}">
                        <td>
                            <strong>${escapeHtml(site.name || '')}</strong>
                            ${hasCoordinates ? '<span class="badge bg-info ms-2">üìç</span>' : ''}
                        </td>
                        <td>
                            ${escapeHtml(site.address || '-')}
                            ${locationInfo}
                        </td>
                        <td>${status}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editSite(${site.id})" title="Update Site">
                                    ‚úèÔ∏è
                                </button>
                                <a href="locations.html?site_id=${site.id}" class="btn btn-outline-info" title="Configure Locations">
                                    üìç
                                </a>
                                ${hasCoordinates ? 
                                    `<button class="btn btn-outline-success" onclick="showSiteOnMap(${site.id})" title="View on Map">
                                        üó∫Ô∏è
                                    </button>` : ''
                                }
                                ${!isArchived ?
                                    `<button class="btn btn-outline-warning" onclick="archiveSite(${site.id})" title="Archive Site">
                                        üì¶
                                    </button>` :
                                    `<button class="btn btn-outline-success" onclick="restoreSite(${site.id})" title="Restore Site">
                                        ‚Ü©Ô∏è
                                    </button>`
                                }
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showSiteOnMap(siteId) {
            const site = allSites.find(s => s.id === siteId);
            if (!site || !site.latitude || !site.longitude) return;

            if (!overviewMap) {
                initializeOverviewMap();
            }

            overviewMap.setView([site.latitude, site.longitude], 15);
            
            // Find and open the marker popup
            const marker = overviewMarkers.find(m => 
                m.getLatLng().lat === site.latitude && m.getLatLng().lng === site.longitude
            );
            if (marker) {
                marker.openPopup();
            }

            // Scroll to map
            document.getElementById('sitesOverviewMap').scrollIntoView({ behavior: 'smooth' });
        }

        function showAddSiteForm() {
            editingSiteId = null;
            document.getElementById('form-title').textContent = 'Create New Site';
            document.getElementById('form-submit-btn').querySelector('.btn-text').textContent = 'Create Site';
            document.getElementById('site-form').reset();
            document.getElementById('site-id').value = '';
            
            // Reset icon picker
            document.querySelectorAll('#siteIconPicker span').forEach(s => s.classList.remove('selected'));
            document.querySelector('#siteIconPicker span').classList.add('selected');
            document.getElementById('site-icon').value = '';
            
            // Initialize form map
            if (!formMap) {
                initializeFormMap();
            }
            
            // Clear form map
            if (formMarker) {
                formMap.removeLayer(formMarker);
                formMarker = null;
            }
            
            document.getElementById('site-form-container').classList.remove('d-none');
            document.getElementById('site-name').focus();
            
            // Refresh map size after showing
            setTimeout(() => {
                if (formMap) {
                    formMap.invalidateSize();
                }
            }, 300);
        }

        function editSite(siteId) {
            const site = allSites.find(s => s.id === siteId);
            if (!site) return;

            editingSiteId = siteId;
            document.getElementById('form-title').textContent = 'Update Site';
            document.getElementById('form-submit-btn').querySelector('.btn-text').textContent = 'Update Site';
            document.getElementById('site-id').value = site.id;
            document.getElementById('site-name').value = site.name || '';
            document.getElementById('site-address').value = site.address || '';
            document.getElementById('site-latitude').value = site.latitude || '';
            document.getElementById('site-longitude').value = site.longitude || '';

            // Set icon
            document.querySelectorAll('#siteIconPicker span').forEach(s => {
                s.classList.toggle('selected', s.dataset.icon === (site.icon_name || ''));
            });
            document.getElementById('site-icon').value = site.icon_name || '';

            // Initialize and update form map
            if (!formMap) {
                initializeFormMap();
                setTimeout(() => {
                    if (site.latitude && site.longitude) {
                        formMap.setView([site.latitude, site.longitude], 16);
                        updateFormMapMarker(site.latitude, site.longitude);
                    }
                    formMap.invalidateSize();
                }, 300);
            } else {
                if (site.latitude && site.longitude) {
                    formMap.setView([site.latitude, site.longitude], 16);
                    updateFormMapMarker(site.latitude, site.longitude);
                }
            }

            document.getElementById('site-form-container').classList.remove('d-none');
            document.getElementById('site-name').focus();
            
            setTimeout(() => {
                if (formMap) {
                    formMap.invalidateSize();
                }
            }, 300);
        }

        function cancelForm() {
            document.getElementById('site-form-container').classList.add('d-none');
            document.getElementById('site-form').reset();
            document.getElementById('addressSuggestions').classList.add('d-none');
            editingSiteId = null;
            
            if (formMarker) {
                formMap.removeLayer(formMarker);
                formMarker = null;
            }
        }

        async function archiveSite(siteId) {
            const site = allSites.find(s => s.id === siteId);
            if (!site) return;

            if (!confirm('Archive site "' + site.name + '"? This will preserve all historical data but mark the site as inactive.')) {
                return;
            }

            try {
                const api = new APIClient('https://api.sensemy.cloud');
                await api.put('/v1/sites/' + siteId, {
                    ...site,
                    archived_at: new Date().toISOString()
                });

                showAlert('success', `Site "${site.name}" archived successfully`);
                await loadSites();

            } catch (err) {
                showAlert('danger', 'Failed to archive site: ' + err.message);
            }
        }

        async function restoreSite(siteId) {
            const site = allSites.find(s => s.id === siteId);
            if (!site) return;

            if (!confirm('Restore site "' + site.name + '"? This will make the site active again.')) {
                return;
            }

            try {
                const api = new APIClient('https://api.sensemy.cloud');
                await api.put('/v1/sites/' + siteId, {
                    ...site,
                    archived_at: null
                });

                showAlert('success', `Site "${site.name}" restored successfully`);
                await loadSites();

            } catch (err) {
                showAlert('danger', 'Failed to restore site: ' + err.message);
            }
        }

        // Handle form submission
        document.getElementById('site-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('form-submit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const originalText = btnText.textContent;

            // Validate required fields
            const name = document.getElementById('site-name').value.trim();
            if (!name) {
                showAlert('warning', 'Site name is required');
                document.getElementById('site-name').focus();
                return;
            }

            const latitude = parseFloat(document.getElementById('site-latitude').value);
            const longitude = parseFloat(document.getElementById('site-longitude').value);
            
            if (!latitude || !longitude) {
                showAlert('warning', 'Please select a location on the map or search for an address');
                return;
            }

            try {
                submitBtn.classList.add('btn-loading');
                submitBtn.disabled = true;
                btnText.textContent = editingSiteId ? 'Updating...' : 'Creating...';

                const formData = {
                    name: name,
                    address: document.getElementById('site-address').value.trim() || null,
                    latitude: latitude,
                    longitude: longitude,
                    icon_name: document.getElementById('site-icon').value || null
                };

                const api = new APIClient('https://api.sensemy.cloud');

                if (editingSiteId) {
                    await api.put('/v1/sites/' + editingSiteId, formData);
                    showAlert('success', `Site "${name}" updated successfully!`);
                } else {
                    await api.post('/v1/locations/site', formData);
                    showAlert('success', `Site "${name}" created successfully!`);
                }

                await loadSites();
                cancelForm();

            } catch (err) {
                console.error('Error saving site:', err);
                showAlert('danger', 'Failed to save site: ' + err.message);
            } finally {
                submitBtn.classList.remove('btn-loading');
                submitBtn.disabled = false;
                btnText.textContent = originalText;
            }
        });

        async function geocodeSite(siteId) {
            const site = allSites.find(s => s.id === siteId);
            if (!site || !site.address) {
                showAlert('warning', 'Site must have an address to find coordinates');
                return;
            }

            try {
                showAlert('info', 'Searching for coordinates...');
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(site.address)}&limit=1&countrycodes=fr,gb&addressdetails=1`);
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = data[0];
                    const latitude = parseFloat(result.lat);
                    const longitude = parseFloat(result.lon);
                    
                    // Update the site with coordinates
                    const api = new APIClient('https://api.sensemy.cloud');
                    await api.put('/v1/sites/' + siteId, {
                        ...site,
                        latitude: latitude,
                        longitude: longitude,
                        address: result.display_name // Update with standardized address
                    });
                    
                    showAlert('success', `Coordinates found and saved for ${site.name}!`);
                    await loadSites(); // Reload to show updated data
                    
                } else {
                    showAlert('warning', `No coordinates found for address: ${site.address}`);
                }
            } catch (error) {
                console.error('Error geocoding site:', error);
                showAlert('danger', 'Error finding coordinates: ' + error.message);
            }
        }

        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            const container = document.querySelector('.container');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = alertHtml;

            container.insertBefore(tempDiv.firstElementChild, container.firstElementChild);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text.toString();
            return div.innerHTML;
        }
    </script>
</body>
</html>
