<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verdegris IoT Platform V4 - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .workflow-card {
            border: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .workflow-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        /* Clickable dashboard cards with solid colors */
        .dashboard-card {
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            border: 2px solid transparent;
        }
        
        .dashboard-card:hover {
            color: inherit;
            text-decoration: none;
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.25);
            border-color: rgba(255,255,255,0.3);
        }
        
        .dashboard-card:active {
            transform: translateY(-1px);
        }
        
        .dashboard-card .card-body {
            position: relative;
        }
        
        .dashboard-card .click-hint {
            opacity: 0;
            transition: opacity 0.3s ease;
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 0.75rem;
        }
        
        .dashboard-card:hover .click-hint {
            opacity: 0.8;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .action-btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 12px 24px;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .workflow-step {
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .workflow-step:hover {
            border-color: #007bff;
            transform: translateY(-2px);
        }
        
        /* Solid color themes matching device-types page */
        .card-header.device-types-theme { background-color: #17a2b8; }
        .card-header.device-locations-theme { background-color: #28a745; }
        .badge.device-types-theme { background-color: #17a2b8; }
        .badge.sites-theme { background-color: #6f42c1; }
        .badge.locations-theme { background-color: #fd7e14; }
        .badge.device-locations-theme { background-color: #28a745; }
        .btn.device-types-theme { background-color: #17a2b8; border-color: #17a2b8; }
        .btn.device-locations-theme { background-color: #28a745; border-color: #28a745; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">Verdegris IoT Platform V4</a>
            <div class="navbar-nav">
                <a class="nav-link active" href="dashboard.html">Dashboard</a>
                <a class="nav-link" href="device-types.html">Device Types</a>
                <a class="nav-link" href="sites.html">Sites</a>
                <a class="nav-link" href="locations.html">Locations</a>
                <a class="nav-link" href="devices.html">Device Locations</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1>System Overview <span class="badge bg-primary">V4</span></h1>
                <p class="text-muted">Real-time metrics and system status</p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading dashboard data...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="alert alert-danger d-none" role="alert">
            <h4 class="alert-heading">Error Loading Data</h4>
            <p id="error-message"></p>
            <button class="btn btn-outline-danger" onclick="loadDashboard()">Retry</button>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" class="d-none">
            <!-- Main Overview Stats - Solid Colors -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <a href="devices.html" class="dashboard-card">
                        <div class="card workflow-card bg-primary text-white">
                            <div class="card-body text-center">
                                <div class="stat-number" id="total-devices">-</div>
                                <h6 class="card-title">Total Devices</h6>
                                <p class="card-text mb-0"><small class="opacity-75">üì± All registered devices</small></p>
                                <div class="click-hint">Click to manage ‚Üí</div>
                            </div>
                        </div>
                    </a>
                </div>
                
                <div class="col-md-3">
                    <a href="devices.html?filter=configured" class="dashboard-card">
                        <div class="card workflow-card bg-success text-white">
                            <div class="card-body text-center">
                                <div class="stat-number" id="configured-devices">-</div>
                                <h6 class="card-title">Fully Configured</h6>
                                <p class="card-text mb-0"><small class="opacity-75">‚úÖ Type + Location</small></p>
                                <div class="click-hint">Click to view ‚Üí</div>
                            </div>
                        </div>
                    </a>
                </div>
                
                <div class="col-md-3">
                    <a href="device-types.html?filter=needs-setup" class="dashboard-card">
                        <div class="card workflow-card bg-warning text-white">
                            <div class="card-body text-center">
                                <div class="stat-number" id="orphan-devices">-</div>
                                <h6 class="card-title">Needs Setup</h6>
                                <p class="card-text mb-0"><small class="opacity-75">‚ö†Ô∏è Missing Type or Location</small></p>
                                <div class="click-hint">Click to fix ‚Üí</div>
                            </div>
                        </div>
                    </a>
                </div>
                
                <div class="col-md-3">
                    <a href="sites.html" class="dashboard-card">
                        <div class="card workflow-card bg-info text-white">
                            <div class="card-body text-center">
                                <div class="stat-number" id="total-sites">-</div>
                                <h6 class="card-title">Active Sites</h6>
                                <p class="card-text mb-0"><small class="opacity-75">üè¢ Physical locations</small></p>
                                <div class="click-hint">Click to manage ‚Üí</div>
                            </div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Configuration Workflow - Solid Colors -->
            <div class="row mb-4">
                <!-- Device Types Section -->
                <div class="col-md-6 mb-4">
                    <div class="card workflow-card h-100">
                        <div class="card-header device-types-theme text-white">
                            <h5 class="card-title mb-0">üîß Device Type Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <a href="device-types.html?filter=has-type" class="text-decoration-none">
                                        <div class="stat-number text-success" id="typed-devices">-</div>
                                        <p class="mb-0 text-muted">Have Type</p>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="device-types.html?filter=needs-type" class="text-decoration-none">
                                        <div class="stat-number text-warning" id="untyped-devices">-</div>
                                        <p class="mb-0 text-muted">Need Type</p>
                                    </a>
                                </div>
                            </div>
                            <div class="d-grid">
                                <a href="device-types.html" class="btn action-btn text-white device-types-theme">
                                    üîß Manage Device Types
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Assignment Section -->
                <div class="col-md-6 mb-4">
                    <div class="card workflow-card h-100">
                        <div class="card-header device-locations-theme text-white">
                            <h5 class="card-title mb-0">üìç Location Assignment</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <a href="devices.html?filter=has-location" class="text-decoration-none">
                                        <div class="stat-number text-success" id="located-devices">-</div>
                                        <p class="mb-0 text-muted">Have Location</p>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="devices.html?filter=needs-location" class="text-decoration-none">
                                        <div class="stat-number text-warning" id="unlocated-devices">-</div>
                                        <p class="mb-0 text-muted">Need Location</p>
                                    </a>
                                </div>
                            </div>
                            <div class="d-grid">
                                <a href="devices.html" class="btn action-btn text-white device-locations-theme">
                                    üìç Assign Device Locations
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Setup Workflow Guide -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card workflow-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">üöÄ V4 Configuration Workflow</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-light border-0" style="background: rgba(0,123,255,0.1);">
                                <h6 class="text-primary">üí° Understanding Device Status:</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <span class="badge bg-success me-2">‚úÖ</span><strong>Fully Configured:</strong> Device has both type AND location
                                    </div>
                                    <div class="col-md-4">
                                        <span class="badge bg-warning me-2">‚ö†Ô∏è</span><strong>Needs Setup:</strong> Missing type OR location
                                    </div>
                                    <div class="col-md-4">
                                        <span class="badge bg-secondary me-2">üì¶</span><strong>Decommissioned:</strong> Retired but preserved
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <a href="device-types.html" class="text-decoration-none">
                                        <div class="workflow-step card text-center p-3">
                                            <div class="mb-3">
                                                <div class="badge device-types-theme text-white fs-6 mb-2">Step 1</div>
                                            </div>
                                            <h6>Setup Device Types</h6>
                                            <p class="text-muted small mb-3">Define what types of devices you have</p>
                                            <div class="btn btn-outline-info btn-sm action-btn">
                                                üîß Device Types
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="sites.html" class="text-decoration-none">
                                        <div class="workflow-step card text-center p-3">
                                            <div class="mb-3">
                                                <div class="badge sites-theme text-white fs-6 mb-2">Step 2</div>
                                            </div>
                                            <h6>Create Sites</h6>
                                            <p class="text-muted small mb-3">Set up your physical facilities</p>
                                            <div class="btn btn-outline-secondary btn-sm action-btn">
                                                üè¢ Sites
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="locations.html" class="text-decoration-none">
                                        <div class="workflow-step card text-center p-3">
                                            <div class="mb-3">
                                                <div class="badge locations-theme text-white fs-6 mb-2">Step 3</div>
                                            </div>
                                            <h6>Configure Locations</h6>
                                            <p class="text-muted small mb-3">Build your site hierarchy</p>
                                            <div class="btn btn-outline-warning btn-sm action-btn">
                                                üìç Locations
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="devices.html" class="text-decoration-none">
                                        <div class="workflow-step card text-center p-3">
                                            <div class="mb-3">
                                                <div class="badge device-locations-theme text-white fs-6 mb-2">Step 4</div>
                                            </div>
                                            <h6>Assign Devices</h6>
                                            <p class="text-muted small mb-3">Place devices in locations</p>
                                            <div class="btn btn-outline-success btn-sm action-btn">
                                                üì± Device Locations
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="row">
                <div class="col-12">
                    <div class="card workflow-card">
                        <div class="card-body text-center">
                            <small class="text-muted">Last updated: <span id="last-updated">-</span></small>
                            <button class="btn btn-outline-primary btn-sm ms-3 action-btn" onclick="loadDashboard()">
                                üîÑ Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadDashboard);

        async function loadDashboard() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('dashboard-content');
            
            loading.classList.remove('d-none');
            error.classList.add('d-none');
            content.classList.add('d-none');
            
            try {
                const api = new APIClient('https://api.sensemy.cloud');
                
                const [devices, sites] = await Promise.all([
                    api.get('/v1/devices'),
                    api.get('/v1/sites').catch(() => [])
                ]);
                
                // Calculate enhanced device statistics
                const stats = {
                    total: devices.length,
                    typed: devices.filter(d => d.device_type && d.device_type !== null).length,
                    located: devices.filter(d => d.location && d.location.zone !== null).length,
                    configured: devices.filter(d => 
                        d.device_type && d.device_type !== null && 
                        d.location && d.location.zone !== null
                    ).length,
                    orphan: devices.filter(d => d.status === 'ORPHAN').length,
                    decommissioned: devices.filter(d => d.status === 'DECOMMISSIONED').length
                };
                
                stats.untyped = stats.total - stats.typed - stats.decommissioned;
                stats.unlocated = stats.total - stats.located - stats.decommissioned;
                
                // Update all displays
                document.getElementById('total-devices').textContent = stats.total;
                document.getElementById('configured-devices').textContent = stats.configured;
                document.getElementById('orphan-devices').textContent = stats.orphan;
                document.getElementById('total-sites').textContent = sites.filter(s => !s.archived_at).length;
                
                document.getElementById('typed-devices').textContent = stats.typed;
                document.getElementById('untyped-devices').textContent = stats.untyped;
                document.getElementById('located-devices').textContent = stats.located;
                document.getElementById('unlocated-devices').textContent = stats.unlocated;
                
                document.getElementById('last-updated').textContent = new Date().toLocaleString();
                
                loading.classList.add('d-none');
                content.classList.remove('d-none');
                
            } catch (err) {
                console.error('Error loading dashboard:', err);
                loading.classList.add('d-none');
                error.classList.remove('d-none');
                document.getElementById('error-message').textContent = 
                    'Failed to load dashboard data: ' + err.message;
            }
        }
    </script>
</body>
</html>
